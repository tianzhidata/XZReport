!function(e,t,r){"use strict";t=void 0!==t&&t.Math==Math?t:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")(),e.api=e.fn.api=function(n){var o,s=e.isFunction(this)?e(t):e(this),i=s.selector||"",a=(new Date).getTime(),u=[],c=n,d="string"==typeof c,l=[].slice.call(arguments,1);return s.each((function(){var s,f,g,p,m,b=e.isPlainObject(n)?e.extend(!0,{},e.fn.api.settings,n):e.extend({},e.fn.api.settings),v=b.namespace,h=b.metadata,y=b.selector,q=b.error,R=b.className,x="."+v,S="module-"+v,A=e(this),k=A.closest(y.form),T=b.stateContext?e(b.stateContext):A,P=this,j=T[0],O=A.data(S),w={initialize:function(){d||w.bind.events(),w.instantiate()},instantiate:function(){w.verbose("Storing instance of module",w),O=w,A.data(S,O)},destroy:function(){w.verbose("Destroying previous module for",P),A.removeData(S).off(x)},bind:{events:function(){var e=w.get.event();e?(w.verbose("Attaching API events to element",e),A.on(e+x,w.event.trigger)):"now"==b.on&&(w.debug("Querying API endpoint immediately"),w.query())}},decode:{json:function(e){if(e!==r&&"string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}},read:{cachedResponse:function(e){var n;if(t.Storage!==r)return n=sessionStorage.getItem(e),w.debug("Using cached response",e,n),w.decode.json(n);w.error(q.noStorage)}},write:{cachedResponse:function(n,o){o&&""===o?w.debug("Response empty, not caching",o):t.Storage!==r?(e.isPlainObject(o)&&(o=JSON.stringify(o)),sessionStorage.setItem(n,o),w.verbose("Storing cached response for url",n,o)):w.error(q.noStorage)}},query:function(){if(w.is.disabled())w.debug("Element is disabled API request aborted");else{if(w.is.loading()){if(!b.interruptRequests)return void w.debug("Cancelling request, previous request is still pending");w.debug("Interrupting previous request"),w.abort()}if(b.defaultData&&e.extend(!0,b.urlData,w.get.defaultData()),b.serializeForm&&(b.data=w.add.formData(b.data)),!1===(f=w.get.settings()))return w.cancelled=!0,void w.error(q.beforeSend);if(w.cancelled=!1,(g=w.get.templatedURL())||w.is.mocked()){if((g=w.add.urlData(g))||w.is.mocked()){if(f.url=b.base+g,s=e.extend(!0,{},b,{type:b.method||b.type,data:p,url:b.base+g,beforeSend:b.beforeXHR,success:function(){},failure:function(){},complete:function(){}}),w.debug("Querying URL",s.url),w.verbose("Using AJAX settings",s),"local"===b.cache&&w.read.cachedResponse(g))return w.debug("Response returned from local cache"),w.request=w.create.request(),void w.request.resolveWith(j,[w.read.cachedResponse(g)]);b.throttle?b.throttleFirstRequest||w.timer?(w.debug("Throttling request",b.throttle),clearTimeout(w.timer),w.timer=setTimeout((function(){w.timer&&delete w.timer,w.debug("Sending throttled request",p,s.method),w.send.request()}),b.throttle)):(w.debug("Sending request",p,s.method),w.send.request(),w.timer=setTimeout((function(){}),b.throttle)):(w.debug("Sending request",p,s.method),w.send.request())}}else w.error(q.missingURL)}},should:{removeError:function(){return!0===b.hideError||"auto"===b.hideError&&!w.is.form()}},is:{disabled:function(){return 0<A.filter(y.disabled).length},expectingJSON:function(){return"json"===b.dataType||"jsonp"===b.dataType},form:function(){return A.is("form")||T.is("form")},mocked:function(){return b.mockResponse||b.mockResponseAsync||b.response||b.responseAsync},input:function(){return A.is("input")},loading:function(){return!!w.request&&"pending"==w.request.state()},abortedRequest:function(e){return e&&e.readyState!==r&&0===e.readyState?(w.verbose("XHR request determined to be aborted"),!0):(w.verbose("XHR request was not aborted"),!1)},validResponse:function(t){return w.is.expectingJSON()&&e.isFunction(b.successTest)?(w.debug("Checking JSON returned success",b.successTest,t),b.successTest(t)?(w.debug("Response passed success test",t),!0):(w.debug("Response failed success test",t),!1)):(w.verbose("Response is not JSON, skipping validation",b.successTest,t),!0)}},was:{cancelled:function(){return w.cancelled||!1},succesful:function(){return w.request&&"resolved"==w.request.state()},failure:function(){return w.request&&"rejected"==w.request.state()},complete:function(){return w.request&&("resolved"==w.request.state()||"rejected"==w.request.state())}},add:{urlData:function(t,n){var o,s;return t&&(o=t.match(b.regExp.required),s=t.match(b.regExp.optional),n=n||b.urlData,o&&(w.debug("Looking for required URL variables",o),e.each(o,(function(o,s){var i=-1!==s.indexOf("$")?s.substr(2,s.length-3):s.substr(1,s.length-2),a=e.isPlainObject(n)&&n[i]!==r?n[i]:A.data(i)!==r?A.data(i):T.data(i)!==r?T.data(i):n[i];if(a===r)return w.error(q.requiredParameter,i,t),t=!1;w.verbose("Found required variable",i,a),a=b.encodeParameters?w.get.urlEncodedValue(a):a,t=t.replace(s,a)}))),s&&(w.debug("Looking for optional URL variables",o),e.each(s,(function(o,s){var i=-1!==s.indexOf("$")?s.substr(3,s.length-4):s.substr(2,s.length-3),a=e.isPlainObject(n)&&n[i]!==r?n[i]:A.data(i)!==r?A.data(i):T.data(i)!==r?T.data(i):n[i];t=a!==r?(w.verbose("Optional variable Found",i,a),t.replace(s,a)):(w.verbose("Optional variable not found",i),-1!==t.indexOf("/"+s)?t.replace("/"+s,""):t.replace(s,""))})))),t},formData:function(t){var n=e.fn.serializeObject!==r,o=n?k.serializeObject():k.serialize();return t=t||b.data,e.isPlainObject(t)?n?(w.debug("Extending existing data with form data",t,o),e.extend(!0,{},t,o)):(w.error(q.missingSerialize),w.debug("Cant extend data. Replacing data with form data",t,o),o):(w.debug("Adding form data",o),o)}},send:{request:function(){w.set.loading(),w.request=w.create.request(),w.is.mocked()?w.mockedXHR=w.create.mockedXHR():w.xhr=w.create.xhr(),b.onRequest.call(j,w.request,w.xhr)}},event:{trigger:function(e){w.query(),"submit"!=e.type&&"click"!=e.type||e.preventDefault()},xhr:{always:function(){},done:function(t,r,n){var o=this,s=(new Date).getTime()-m,i=b.loadingDuration-s,a=!!e.isFunction(b.onResponse)&&(w.is.expectingJSON()?b.onResponse.call(o,e.extend(!0,{},t)):b.onResponse.call(o,t));i=0<i?i:0;a&&(w.debug("Modified API response in onResponse callback",b.onResponse,a,t),t=a),0<i&&w.debug("Response completed early delaying state change by",i),setTimeout((function(){w.is.validResponse(t)?w.request.resolveWith(o,[t,n]):w.request.rejectWith(o,[n,"invalid"])}),i)},fail:function(e,t,r){var n=this,o=(new Date).getTime()-m,s=b.loadingDuration-o;0<(s=0<s?s:0)&&w.debug("Response completed early delaying state change by",s),setTimeout((function(){w.is.abortedRequest(e)?w.request.rejectWith(n,[e,"aborted",r]):w.request.rejectWith(n,[e,"error",t,r])}),s)}},request:{done:function(e,t){w.debug("Successful API Response",e),"local"===b.cache&&g&&(w.write.cachedResponse(g,e),w.debug("Saving server response locally",w.cache)),b.onSuccess.call(j,e,A,t)},complete:function(e,t){var r,n;w.was.succesful()?(n=e,r=t):(r=e,n=w.get.responseFromXHR(r)),w.remove.loading(),b.onComplete.call(j,n,A,r)},fail:function(e,t,n){var o=w.get.responseFromXHR(e),i=w.get.errorFromRequest(o,t,n);if("aborted"==t)return w.debug("XHR Aborted (Most likely caused by page navigation or CORS Policy)",t,n),b.onAbort.call(j,t,A,e),!0;"invalid"==t?w.debug("JSON did not pass success test. A server-side error has most likely occurred",o):"error"==t&&e!==r&&(w.debug("XHR produced a server error",t,n),200!=e.status&&n!==r&&""!==n&&w.error(q.statusMessage+n,s.url),b.onError.call(j,i,A,e)),b.errorDuration&&"aborted"!==t&&(w.debug("Adding error state"),w.set.error(),w.should.removeError()&&setTimeout(w.remove.error,b.errorDuration)),w.debug("API Request failed",i,e),b.onFailure.call(j,o,A,e)}}},create:{request:function(){return e.Deferred().always(w.event.request.complete).done(w.event.request.done).fail(w.event.request.fail)},mockedXHR:function(){var t,r,n=b.mockResponse||b.response,o=b.mockResponseAsync||b.responseAsync,s=e.Deferred().always(w.event.xhr.complete).done(w.event.xhr.done).fail(w.event.xhr.fail);return n?(r=e.isFunction(n)?(w.debug("Using specified synchronous callback",n),n.call(j,f)):(w.debug("Using settings specified response",n),n),s.resolveWith(j,[r,!1,{responseText:r}])):e.isFunction(o)&&(t=function(e){w.debug("Async callback returned response",e),e?s.resolveWith(j,[e,!1,{responseText:e}]):s.rejectWith(j,[{responseText:e},!1,!1])},w.debug("Using specified async response callback",o),o.call(j,f,t)),s},xhr:function(){var t=e.ajax(s).always(w.event.xhr.always).done(w.event.xhr.done).fail(w.event.xhr.fail);return w.verbose("Created server request",t,s),t}},set:{error:function(){w.verbose("Adding error state to element",T),T.addClass(R.error)},loading:function(){w.verbose("Adding loading state to element",T),T.addClass(R.loading),m=(new Date).getTime()}},remove:{error:function(){w.verbose("Removing error state from element",T),T.removeClass(R.error)},loading:function(){w.verbose("Removing loading state from element",T),T.removeClass(R.loading)}},get:{responseFromXHR:function(t){return!!e.isPlainObject(t)&&(w.is.expectingJSON()?w.decode.json(t.responseText):t.responseText)},errorFromRequest:function(t,n,o){return e.isPlainObject(t)&&t.error!==r?t.error:b.error[n]!==r?b.error[n]:o},request:function(){return w.request||!1},xhr:function(){return w.xhr||!1},settings:function(){var t=b.beforeSend.call(j,b);return t&&(t.success!==r&&(w.debug("Legacy success callback detected",t),w.error(q.legacyParameters,t.success),t.onSuccess=t.success),t.failure!==r&&(w.debug("Legacy failure callback detected",t),w.error(q.legacyParameters,t.failure),t.onFailure=t.failure),t.complete!==r&&(w.debug("Legacy complete callback detected",t),w.error(q.legacyParameters,t.complete),t.onComplete=t.complete)),t===r&&w.error(q.noReturnedValue),!1===t?t:t!==r?e.extend(!0,{},t):e.extend(!0,{},b)},urlEncodedValue:function(e){var r=t.decodeURIComponent(e),n=t.encodeURIComponent(e);return r!==e?(w.debug("URL value is already encoded, avoiding double encoding",e),e):(w.verbose("Encoding value using encodeURIComponent",e,n),n)},defaultData:function(){var t={};return e.isWindow(P)||(w.is.input()?t.value=A.val():w.is.form()||(t.text=A.text())),t},event:function(){return e.isWindow(P)||"now"==b.on?(w.debug("API called without element, no events attached"),!1):"auto"==b.on?A.is("input")?P.oninput!==r?"input":P.onpropertychange!==r?"propertychange":"keyup":A.is("form")?"submit":"click":b.on},templatedURL:function(e){if(e=e||A.data(h.action)||b.action||!1,g=A.data(h.url)||b.url||!1)return w.debug("Using specified url",g),g;if(e){if(w.debug("Looking up url for action",e,b.api),b.api[e]===r&&!w.is.mocked())return void w.error(q.missingAction,b.action,b.api);g=b.api[e]}else w.is.form()&&(g=A.attr("action")||T.attr("action")||!1,w.debug("No url or action specified, defaulting to form action",g));return g}},abort:function(){var e=w.get.xhr();e&&"resolved"!==e.state()&&(w.debug("Cancelling API request"),e.abort())},reset:function(){w.remove.error(),w.remove.loading()},setting:function(t,n){if(w.debug("Changing setting",t,n),e.isPlainObject(t))e.extend(!0,b,t);else{if(n===r)return b[t];e.isPlainObject(b[t])?e.extend(!0,b[t],n):b[t]=n}},internal:function(t,n){if(e.isPlainObject(t))e.extend(!0,w,t);else{if(n===r)return w[t];w[t]=n}},debug:function(){!b.silent&&b.debug&&(b.performance?w.performance.log(arguments):(w.debug=Function.prototype.bind.call(console.info,console,b.name+":"),w.debug.apply(console,arguments)))},verbose:function(){!b.silent&&b.verbose&&b.debug&&(b.performance?w.performance.log(arguments):(w.verbose=Function.prototype.bind.call(console.info,console,b.name+":"),w.verbose.apply(console,arguments)))},error:function(){b.silent||(w.error=Function.prototype.bind.call(console.error,console,b.name+":"),w.error.apply(console,arguments))},performance:{log:function(e){var t,r;b.performance&&(r=(t=(new Date).getTime())-(a||t),a=t,u.push({Name:e[0],Arguments:[].slice.call(e,1)||"","Execution Time":r})),clearTimeout(w.performance.timer),w.performance.timer=setTimeout(w.performance.display,500)},display:function(){var t=b.name+":",n=0;a=!1,clearTimeout(w.performance.timer),e.each(u,(function(e,t){n+=t["Execution Time"]})),t+=" "+n+"ms",i&&(t+=" '"+i+"'"),(console.group!==r||console.table!==r)&&0<u.length&&(console.groupCollapsed(t),console.table?console.table(u):e.each(u,(function(e,t){t.Name,t["Execution Time"]})),console.groupEnd()),u=[]}},invoke:function(t,n,s){var i,a,u,c=O;return n=n||l,s=P||s,"string"==typeof t&&c!==r&&(t=t.split(/[\. ]/),i=t.length-1,e.each(t,(function(n,o){var s=n!=i?o+t[n+1].charAt(0).toUpperCase()+t[n+1].slice(1):t;if(e.isPlainObject(c[s])&&n!=i)c=c[s];else{if(c[s]!==r)return a=c[s],!1;if(!e.isPlainObject(c[o])||n==i)return c[o]!==r?a=c[o]:w.error(q.method,t),!1;c=c[o]}}))),e.isFunction(a)?u=a.apply(s,n):a!==r&&(u=a),e.isArray(o)?o.push(u):o!==r?o=[o,u]:u!==r&&(o=u),a}};d?(O===r&&w.initialize(),w.invoke(c)):(O!==r&&O.invoke("destroy"),w.initialize())})),o!==r?o:this},e.api.settings={name:"API",namespace:"api",debug:!1,verbose:!1,performance:!0,api:{},cache:!0,interruptRequests:!0,on:"auto",stateContext:!1,loadingDuration:0,hideError:"auto",errorDuration:2e3,encodeParameters:!0,action:!1,url:!1,base:"",urlData:{},defaultData:!0,serializeForm:!1,throttle:0,throttleFirstRequest:!0,method:"get",data:{},dataType:"json",mockResponse:!1,mockResponseAsync:!1,response:!1,responseAsync:!1,beforeSend:function(e){return e},beforeXHR:function(e){},onRequest:function(e,t){},onResponse:!1,onSuccess:function(e,t){},onComplete:function(e,t){},onFailure:function(e,t){},onError:function(e,t){},onAbort:function(e,t){},successTest:!1,error:{beforeSend:"The before send function has aborted the request",error:"There was an error with your request",exitConditions:"API Request Aborted. Exit conditions met",JSONParse:"JSON could not be parsed during error handling",legacyParameters:"You are using legacy API success callback names",method:"The method you called is not defined",missingAction:"API action used but no url was defined",missingSerialize:"jquery-serialize-object is required to add form data to an existing data object",missingURL:"No URL specified for api event",noReturnedValue:"The beforeSend callback must return a settings object, beforeSend ignored.",noStorage:"Caching responses locally requires session storage",parseError:"There was an error parsing your request",requiredParameter:"Missing a required URL parameter: ",statusMessage:"Server gave an error: ",timeout:"Your request timed out"},regExp:{required:/\{\$*[A-z0-9]+\}/g,optional:/\{\/\$*[A-z0-9]+\}/g},className:{loading:"loading",error:"error"},selector:{disabled:".disabled",form:"form"},metadata:{action:"action",url:"url"}}}(jQuery,window,void document);